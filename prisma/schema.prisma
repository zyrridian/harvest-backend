// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  password     String    // Hashed with bcrypt
  name         String
  phoneNumber  String?   @map("phone_number")
  avatarUrl    String?   @map("avatar_url")
  userType     UserType  @default(CONSUMER) @map("user_type")
  isVerified   Boolean   @default(false) @map("is_verified")
  isOnline     Boolean   @default(false) @map("is_online")
  lastSeen     DateTime? @map("last_seen")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  refreshTokens         RefreshToken[]
  products              Product[]
  profile               UserProfile?
  farmer                Farmer?
  favorites             Favorite[]
  productViews          ProductView[]
  cart                  Cart?
  buyerOrders           Order[]              @relation("BuyerOrders")
  sellerOrders          Order[]              @relation("SellerOrders")
  addresses             Address[]
  reviews               Review[]
  reviewHelpful         ReviewHelpful[]
  searchHistory         SearchHistory[]
  conversationsAsP1     Conversation[]       @relation("Participant1")
  conversationsAsP2     Conversation[]       @relation("Participant2")
  sentMessages          Message[]

  @@index([email])
  @@index([userType])
  @@map("users")
}

enum UserType {
  CONSUMER
  PRODUCER
  ADMIN
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model UserProfile {
  userId         String   @id @map("user_id")
  bio            String?
  followersCount Int      @default(0) @map("followers_count")
  responseRate   Float    @default(0) @map("response_rate")
  responseTime   String?  @map("response_time")
  joinedSince    DateTime @default(now()) @map("joined_since")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

// ============================================
// CATEGORIES
// ============================================

model Category {
  id             String        @id @default(uuid())
  name           String
  slug           String        @unique
  description    String?
  emoji          String?
  gradientColors String[]      @map("gradient_colors")
  productCount   Int           @default(0) @map("product_count")
  displayOrder   Int           @default(0) @map("display_order")
  isActive       Boolean       @default(true) @map("is_active")

  // Relations
  products      Product[]
  subcategories Subcategory[]

  @@index([slug])
  @@index([displayOrder])
  @@map("categories")
}

model Subcategory {
  id           String   @id @default(uuid())
  categoryId   String   @map("category_id")
  name         String
  slug         String   @unique
  description  String?
  productCount Int      @default(0) @map("product_count")
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")

  // Relations
  category Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  products Product[]

  @@index([categoryId])
  @@index([slug])
  @@map("subcategories")
}

// ============================================
// PRODUCTS
// ============================================

model Product {
  id              String    @id @default(uuid())
  name            String
  slug            String?   @unique
  description     String?
  longDescription String?   @map("long_description")
  categoryId      String?   @map("category_id")
  subcategoryId   String?   @map("subcategory_id")
  sellerId        String    @map("seller_id")
  price           Float
  currency        String    @default("IDR")
  unit            String
  unitWeight      Float     @default(1.0) @map("unit_weight")
  stockQuantity   Int       @default(0) @map("stock_quantity")
  minimumOrder    Int       @default(1) @map("minimum_order")
  maximumOrder    Int       @default(999) @map("maximum_order")
  isOrganic       Boolean   @default(false) @map("is_organic")
  isAvailable     Boolean   @default(true) @map("is_available")
  rating          Float     @default(0)
  reviewCount     Int       @default(0) @map("review_count")
  viewCount       Int       @default(0) @map("view_count")
  harvestDate     DateTime? @map("harvest_date")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  seller            User                    @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  category          Category?               @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  subcategory       Subcategory?            @relation(fields: [subcategoryId], references: [id], onDelete: SetNull)
  images            ProductImage[]
  videos            ProductVideo[]
  specifications    ProductSpecification[]
  tags              ProductTag[]
  certifications    ProductCertification[]
  discounts         ProductDiscount[]
  favorites         Favorite[]
  views             ProductView[]
  cartItems         CartItem[]
  orderItems        OrderItem[]
  reviews           Review[]
  conversations     Conversation[]

  @@index([sellerId])
  @@index([categoryId])
  @@index([subcategoryId])
  @@index([isAvailable])
  @@map("products")
}

model ProductImage {
  id           String   @id @default(uuid())
  productId    String   @map("product_id")
  url          String
  thumbnailUrl String?  @map("thumbnail_url")
  mediumUrl    String?  @map("medium_url")
  altText      String?  @map("alt_text")
  isPrimary    Boolean  @default(false) @map("is_primary")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

model ProductVideo {
  id           String   @id @default(uuid())
  productId    String   @map("product_id")
  url          String
  thumbnailUrl String?  @map("thumbnail_url")
  duration     Int?
  title        String?
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_videos")
}

model ProductSpecification {
  id           String @id @default(uuid())
  productId    String @map("product_id")
  specKey      String @map("spec_key")
  specValue    String @map("spec_value")
  displayOrder Int    @default(0) @map("display_order")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_specifications")
}

model ProductTag {
  productId String @map("product_id")
  tag       String

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([productId, tag])
  @@index([tag])
  @@map("product_tags")
}

model ProductCertification {
  id                String    @id @default(uuid())
  productId         String    @map("product_id")
  name              String
  issuer            String?
  certificateNumber String?   @map("certificate_number")
  issueDate         DateTime? @map("issue_date")
  expiryDate        DateTime? @map("expiry_date")
  verified          Boolean   @default(false)
  badgeUrl          String?   @map("badge_url")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_certifications")
}

model ProductDiscount {
  id              String    @id @default(uuid())
  productId       String    @map("product_id")
  type            String // 'percentage' or 'fixed_amount'
  value           Float
  discountedPrice Float?    @map("discounted_price")
  validFrom       DateTime? @map("valid_from")
  validUntil      DateTime? @map("valid_until")
  reason          String?
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([validFrom, validUntil])
  @@map("product_discounts")
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  productId String   @map("product_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("favorites")
}

model ProductView {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  userId    String?  @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([productId])
  @@index([userId])
  @@map("product_views")
}

// ============================================
// FARMERS/SELLERS
// ============================================

model Farmer {
  id                 String   @id @default(uuid())
  userId             String   @unique @map("user_id")
  name               String
  description        String?
  profileImage       String?  @map("profile_image")
  coverImage         String?  @map("cover_image")
  latitude           Float?
  longitude          Float?
  address            String?
  city               String?
  state              String?
  rating             Float    @default(0)
  totalReviews       Int      @default(0) @map("total_reviews")
  totalProducts      Int      @default(0) @map("total_products")
  isVerified         Boolean  @default(false) @map("is_verified")
  verificationBadge  String?  @map("verification_badge")
  hasMapFeature      Boolean  @default(false) @map("has_map_feature")
  phoneNumber        String?  @map("phone_number")
  email              String?
  joinedDate         DateTime @default(now()) @map("joined_date")
  followersCount     Int      @default(0) @map("followers_count")

  // Relations
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialties FarmerSpecialty[]

  @@index([userId])
  @@index([latitude, longitude])
  @@index([isVerified])
  @@map("farmers")
}

model FarmerSpecialty {
  farmerId  String @map("farmer_id")
  specialty String

  // Relations
  farmer Farmer @relation(fields: [farmerId], references: [id], onDelete: Cascade)

  @@id([farmerId, specialty])
  @@index([specialty])
  @@map("farmer_specialties")
}

// ============================================
// CART
// ============================================

model Cart {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@map("carts")
}

model CartItem {
  id            String   @id @default(uuid())
  cartId        String   @map("cart_id")
  productId     String   @map("product_id")
  quantity      Int      @default(1)
  unitPrice     Float    @map("unit_price")
  discountPrice Float?   @map("discount_price")
  subtotal      Float
  notes         String?
  isSelected    Boolean  @default(true) @map("is_selected")
  isAvailable   Boolean  @default(true) @map("is_available")
  addedAt       DateTime @default(now()) @map("added_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

// ============================================
// ORDERS
// ============================================

model Order {
  id                  String    @id @default(uuid())
  orderNumber         String    @unique @map("order_number")
  buyerId             String    @map("buyer_id")
  sellerId            String    @map("seller_id")
  status              String    @default("pending_payment")
  subtotal            Float
  deliveryFee         Float     @default(0) @map("delivery_fee")
  serviceFee          Float     @default(0) @map("service_fee")
  totalDiscount       Float     @default(0) @map("total_discount")
  totalAmount         Float     @map("total_amount")
  paymentMethod       String?   @map("payment_method")
  paymentStatus       String?   @map("payment_status")
  deliveryMethod      String?   @map("delivery_method")
  deliveryAddressId   String?   @map("delivery_address_id")
  deliveryDate        DateTime? @map("delivery_date")
  deliveryTimeSlot    String?   @map("delivery_time_slot")
  trackingNumber      String?   @map("tracking_number")
  estimatedArrival    DateTime? @map("estimated_arrival")
  notes               String?
  cancelledReason     String?   @map("cancelled_reason")
  cancelledAt         DateTime? @map("cancelled_at")
  paidAt              DateTime? @map("paid_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  buyer           User        @relation("BuyerOrders", fields: [buyerId], references: [id], onDelete: Cascade)
  seller          User        @relation("SellerOrders", fields: [sellerId], references: [id], onDelete: Cascade)
  deliveryAddress Address?    @relation(fields: [deliveryAddressId], references: [id], onDelete: SetNull)
  items           OrderItem[]
  reviews         Review[]
  conversations   Conversation[]

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id           String  @id @default(uuid())
  orderId      String  @map("order_id")
  productId    String  @map("product_id")
  productName  String  @map("product_name")
  productImage String? @map("product_image")
  quantity     Int
  unitPrice    Float   @map("unit_price")
  discount     Float   @default(0)
  subtotal     Float

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ============================================
// ADDRESSES
// ============================================

model Address {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  label         String
  recipientName String   @map("recipient_name")
  phone         String
  fullAddress   String   @map("full_address")
  province      String
  provinceId    Int      @map("province_id")
  city          String
  cityId        Int      @map("city_id")
  district      String
  districtId    Int      @map("district_id")
  subdistrict   String?
  postalCode    String   @map("postal_code")
  latitude      Float?
  longitude     Float?
  notes         String?
  isPrimary     Boolean  @default(false) @map("is_primary")
  isVerified    Boolean  @default(false) @map("is_verified")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([userId])
  @@index([latitude, longitude])
  @@map("addresses")
}

// ============================================
// REVIEWS
// ============================================

model Review {
  id                 String    @id @default(uuid())
  productId          String    @map("product_id")
  userId             String    @map("user_id")
  orderId            String?   @map("order_id")
  rating             Float
  title              String?
  comment            String?   @db.Text
  isVerifiedPurchase Boolean   @default(false) @map("is_verified_purchase")
  helpfulCount       Int       @default(0) @map("helpful_count")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  product        Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  order          Order?           @relation(fields: [orderId], references: [id], onDelete: SetNull)
  images         ReviewImage[]
  helpfulMarks   ReviewHelpful[]
  sellerResponse SellerResponse?

  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@map("reviews")
}

model ReviewImage {
  id           String @id @default(uuid())
  reviewId     String @map("review_id")
  url          String @db.Text
  thumbnailUrl String? @map("thumbnail_url") @db.Text
  displayOrder Int    @default(0) @map("display_order")

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@map("review_images")
}

model ReviewHelpful {
  reviewId  String   @map("review_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([reviewId, userId])
  @@map("review_helpful")
}

model SellerResponse {
  id          String   @id @default(uuid())
  reviewId    String   @unique @map("review_id")
  comment     String   @db.Text
  respondedAt DateTime @default(now()) @map("responded_at")

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@map("seller_responses")
}

// ============================================
// SEARCH
// ============================================

model SearchHistory {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  query       String
  resultCount Int      @default(0) @map("result_count")
  searchedAt  DateTime @default(now()) @map("searched_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([searchedAt])
  @@map("search_history")
}

// ============================================
// MESSAGING
// ============================================

model Conversation {
  id             String           @id @default(uuid())
  type           ConversationType @default(GENERAL)
  participant1Id String           @map("participant_1_id")
  participant2Id String           @map("participant_2_id")
  orderId        String?          @map("order_id")
  productId      String?          @map("product_id")
  isMutedP1      Boolean          @default(false) @map("is_muted_p1")
  isMutedP2      Boolean          @default(false) @map("is_muted_p2")
  isPinnedP1     Boolean          @default(false) @map("is_pinned_p1")
  isPinnedP2     Boolean          @default(false) @map("is_pinned_p2")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  // Relations
  participant1 User      @relation("Participant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2 User      @relation("Participant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  order        Order?    @relation(fields: [orderId], references: [id], onDelete: SetNull)
  product      Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  messages     Message[]

  @@unique([participant1Id, participant2Id, orderId])
  @@index([participant1Id])
  @@index([participant2Id])
  @@index([orderId])
  @@index([productId])
  @@map("conversations")
}

model Message {
  id                    String      @id @default(uuid())
  conversationId        String      @map("conversation_id")
  senderId              String      @map("sender_id")
  type                  MessageType @default(TEXT)
  content               String?     @db.Text
  replyToMessageId      String?     @map("reply_to_message_id")
  isRead                Boolean     @default(false) @map("is_read")
  readAt                DateTime?   @map("read_at")
  isEdited              Boolean     @default(false) @map("is_edited")
  editedAt              DateTime?   @map("edited_at")
  deletedForSender      Boolean     @default(false) @map("deleted_for_sender")
  deletedForRecipient   Boolean     @default(false) @map("deleted_for_recipient")
  createdAt             DateTime    @default(now()) @map("created_at")

  // Relations
  conversation  Conversation   @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender        User           @relation(fields: [senderId], references: [id], onDelete: Cascade)
  replyTo       Message?       @relation("MessageReplies", fields: [replyToMessageId], references: [id], onDelete: SetNull)
  replies       Message[]      @relation("MessageReplies")
  images        MessageImage[]

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

model MessageImage {
  id           String  @id @default(uuid())
  messageId    String  @map("message_id")
  url          String  @db.Text
  thumbnailUrl String? @map("thumbnail_url") @db.Text
  width        Int?
  height       Int?

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("message_images")
}

// ============================================
// ENUMS
// ============================================

enum ConversationType {
  GENERAL
  ORDER
  PRODUCT

  @@map("conversation_type")
}

enum MessageType {
  TEXT
  IMAGE
  PRODUCT
  ORDER
  VOICE
  SYSTEM

  @@map("message_type")
}
